---
title: "Introduction à Shiny"
author: "R. Cura & H. Commenges"
date: "12 mars 2015"
output:
  html_document:
    theme: cerulean
    toc: yes
runtime: shiny
---


## 1 - Rappel sur les fonctions


## 2 - Exploration basique des données

### Quelle distributions pour les variables ?

```{r}
load("data/eurosex.RData")
```


```{r, fig.show='asis', fig.width=3, fig.height = 3}
hist(eurosex$THREEBED)

hist(eurosex$ONENIGHT)

hist(eurosex$WISHMORE)

hist(eurosex$FREQYEAR)

hist(eurosex$VIBRATOR)

hist(eurosex$FIRSTSEX)
```

Et si on veut changer l'intervalle des barres ?

```{r, fig.show = "hold", fig.width=3}
hist(eurosex$THREEBED, breaks = 10)
hist(eurosex$ONENIGHT, breaks = 10)
hist(eurosex$WISHMORE, breaks = 10)
```

C'est long...



## 3 - Histogramme interactif avec manipulate

```{r, eval=FALSE}
library(manipulate)
manipulate(hist(x = eurosex[[myVar]], breaks = nbBreaks),
           nbBreaks = slider(min = 2, max = 20),
           myVar = picker("THREEBED", "ONENIGHT", "WISHMORE", "FREQYEAR", "VIBRATOR", "FIRSTSEX"))
```

Limites : ne fonctionne que dans RStudio, et ne peut être "partagé".

## 4 - Histogramme interactif avec shiny

Pour des applications plus dynamiques

```{r}
inputPanel(
  selectInput(inputId = "variable", label = "Variable a decrire", choices = colnames(eurosex)),
  sliderInput(inputId = "nbbreaks", label = "Nombre de barres", min = 2, max = 20, value = 5)
  )


renderPlot({
  hist(x = eurosex[[input$variable]], breaks = input$nbbreaks)
})
```


## 4 - Application géographique : CAH interactive avec Shiny

Il faut :

* Un dendrogramme
* Les profils de classe
* Une carte

Paramètres dynamiques : 

* Choix des variables à utiliser
* Nombre de classe


```{r, fig.show='hold', echo=FALSE, fig.width = 3}
row.names(eurosex) <- eurosex$COUNTRYID

inputPanel(
  selectInput(inputId = "variables", label = "Variables à mobiliser", choices = colnames(eurosex), multiple = TRUE),
  sliderInput(inputId = "nbClusters", label = "Nombre de classes", min = 2, max = 10, value = 3)
  )

cah <- reactive({
  hclust(d = dist(subset(eurosex, select = input$variables), method = "euclidean"), method = "ward.D2")
})

clusters <- reactive({
  cutree(tree = cah(), k = input$nbClusters)
})
# Dendrogramme
renderPlot({
  plot(cah(), hang = -1)
})

library(ggplot2)
library(reshape2)
plotProfiles <- function(data, clusters){
  nClusters <- length(unique(clusters))
  cPal <- rainbow(n = nClusters)
  data$CLUSTER <- factor(clusters, levels = 1:nClusters, labels = paste('Cluster', 1:nClusters, sep = " "))
  plotDF <- subset(data, select = -CLUSTER)
  clusProfile <- aggregate(plotDF,
                           by = list(data$CLUSTER),
                           mean)
  colnames(clusProfile)[1] <- "CLUSTER"
  clusLong <- melt(clusProfile, id.vars = "CLUSTER")
  ggplot(clusLong) +
    geom_bar(aes(x = variable, y = value, fill = CLUSTER),
             stat = "identity") +
    scale_fill_manual(values = cPal) +
    facet_wrap(~ CLUSTER) +
    coord_flip() + theme_bw()
  }

# Profils
renderPlot({
  plotProfiles(subset(eurosex, select = input$variables), clusters())
})

# Carte
renderPlot({
  cPal <- rainbow(n = input$nbClusters)
  countryColors <- cPal[clusters()] 
  plot(euromap, col = countryColors)
})

```


## 5 - Créer une application interactive

